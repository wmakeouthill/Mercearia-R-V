<div class="historico-deletados-container">
  <div class="historico-header">
    <h1>üóÑÔ∏è Auditoria de Vendas Deletadas</h1>
    <div class="header-actions">
      <button class="btn-voltar" (click)="voltarAoHistorico()">‚Üê Voltar ao Hist√≥rico</button>
    </div>
  </div>

  <div *ngIf="loading" class="loading">Carregando auditoria...</div>
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="!loading && vendasFiltradas.length > 0" class="vendas-tabela">
    <table class="tabela-vendas">
      <thead>
        <tr>
          <th class="col-numero">N¬∫</th>
          <th class="col-produto">Produto</th>
          <th class="col-qtd">Qtd</th>
          <th class="col-metodo">Pagamentos</th>
          <th class="col-total">Total</th>
          <th class="col-data">Data/Hora</th>
          <th class="col-acoes">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        @for (venda of vendasFiltradas; track venda.row_id; let i = $index) {<tr class="venda-row">
          <td class="venda-numero">{{ vendasFiltradas.length - i }}</td>
          <td class="produto-info">
            <div class="produto-nome com-imagem">
              <img class="produto-thumb-inline" [src]="getImageUrl(venda.produto_imagem)" [alt]="venda.produto_nome" (error)="onImageError($event)">
              <span>{{ venda.produto_nome || 'Produto #' + venda.produto_id }}</span>
            </div>
          </td>
          <td class="quantidade">{{ venda.quantidade_vendida }}</td>
          <td class="metodo-pagamento">
            @if (venda['pagamentos_resumo']) {<div class="pagamentos-resumo">
              {{ venda['pagamentos_resumo'] }}
            </div>} @else {<ng-template>{{ venda.metodo_pagamento }}</ng-template>}
          </td>
          <td class="valor-total">R$ {{ (venda.preco_total || 0).toFixed(2) }}</td>
          <td class="venda-data"><span class="data-hora-inline">{{ formatarData(venda.data_venda) }}</span></td>
          <td class="acoes">
            <button *ngIf="venda.itens && venda.itens.length > 1" type="button" (click)="toggleExpand(venda.row_id)" class="btn-expand" [class.rotated]="expandedRows.has(venda.row_id)" [attr.aria-expanded]="expandedRows.has(venda.row_id)" title="Expandir venda">üîΩ</button>
            <button type="button" (click)="restoreDeletion(venda._deletionId)" class="btn-restaurar"
                    [disabled]="!authService.isAdmin()" [attr.title]="!authService.isAdmin() ? 'Somente administradores podem restaurar vendas' : 'Restaurar venda'">
              ‚ôªÔ∏è
            </button>
          </td>
        </tr>
        @if (venda.itens && expandedRows.has(venda.row_id)) {<tr class="venda-itens-row"><td colspan="7">
          <div class="itens-lista">
            <table class="itens-tabela">
              <thead><tr><th>Produto</th><th>Qtd</th><th>Pre√ßo unit.</th><th>Pre√ßo total</th></tr></thead>
              <tbody>
                @for (it of venda.itens; track it.produto_id) {<tr>
                  <td class="produto-info">
                    <img class="produto-thumb-inline" [src]="getImageUrl(it.produto_imagem || it.produtoImagem)" [alt]="it.produto_nome || it.produtoNome || 'Produto'" (error)="onImageError($event)">
                    <span>{{ it.produto_nome || it.produtoNome }}</span>
                  </td>
                  <td>{{ it.quantidade || it.quantidade_vendida }}</td>
                  <td>R$ {{ (it.preco_unitario || it.precoUnitario || 0).toFixed(2) }}</td>
                  <td>R$ {{ (it.preco_total || it.precoTotal || 0).toFixed(2) }}</td>
                </tr>}
              </tbody>
            </table>
          </div>
        </td></tr>}
        }
      </tbody>
    </table>
  </div>

  <div *ngIf="!loading && deletions.length === 0" class="vazio">Nenhum registro de dele√ß√£o encontrado.</div>
  <div class="paginacao" *ngIf="deletions.length > 0">
    <button (click)="prevPage()" [disabled]="page<=1">‚Äπ Anterior</button>
    <span>P√°gina {{ page }}</span>
    <button (click)="nextPage()" [disabled]="!hasNext">Pr√≥xima ‚Ä∫</button>
  </div>
</div>


