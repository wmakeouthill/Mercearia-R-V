<div class="caixa-container">
  <div class="top-bar">
    <div class="form-mov">
      <h3>Registro de Sessões</h3>
      <div class="acoes-form"></div>
    </div>
    <div class="acoes-topo">
      <button class="btn-voltar btn-voltar-compact" (click)="voltar()">←&nbsp;Voltar ao Dashboard</button>
    </div>
  </div>

  <div class="lista">
    <h3>Sessões</h3>
    <div *ngIf="loading">Carregando...</div>
    <div *ngIf="error" class="erro">{{ error }}</div>
    <div *ngIf="items && items.length">
      <div class="tabela-wrapper">
        <table class="sessoes-table">
          <colgroup>
            <col style="width:5%" />
            <col style="width:5%" />
            <col style="width:22%" />
            <col style="width:15%" />
            <col style="width:15%" />
            <col style="width:15%" />
            <col style="width:10%" />
            <col style="width:7.5%" />
            <col style="width:5.5%" />
            <col style="width:6%" />
          </colgroup>
          <thead>
            <tr>
              <th class="center">ID</th>
              <th class="center">Aberto</th>
              <th>Abertura</th>
              <th>Usuário (Abertura)</th>
              <th>Fechamento</th>
              <th>Usuário (Fechamento)</th>
              <th class="right">Saldo Inicial</th>
              <th class="right">Saldo Contado</th>
              <th class="right">Variação</th>
              <th class="center">Ação</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of items">
              <td class="center">{{ it.id }}</td>
              <td class="center">{{ it.aberto ? 'Sim' : 'Não' }}</td>
              <td>{{ it.data_abertura | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ it.aberto_por || '-' }}</td>
              <td>{{ it.data_fechamento ? (it.data_fechamento | date:'dd/MM/yyyy HH:mm') : '-' }}</td>
              <td>{{ it.fechado_por || '-' }}</td>
              <td class="right">R$&nbsp;{{ it.saldo_inicial | number:'1.2-2' }}</td>
              <td class="right">R$&nbsp;{{ it.saldo_contado | number:'1.2-2' }}</td>
              <td class="right">R$&nbsp;{{ it.variacao | number:'1.2-2' }}</td>
              <td class="center"><button class="btn-primary btn-registro" (click)="openReconciliation(it.id)">Relatório</button></td>
            </tr>
          </tbody>
        </table>
        <div class="paginacao">
          <div class="pagination-left">
            <button class="btn-page btn-ghost" (click)="loadPage(1)" [disabled]="page<=1">«</button>
            <button class="btn-page btn-ghost" (click)="loadPage(page<=1 ? 1 : page-1)" [disabled]="page<=1">‹</button>
          </div>
          <div class="pagination-center">Página {{ page }}</div>
          <div class="pagination-right">
            <button class="btn-page btn-ghost" (click)="loadPage(page+1)" [disabled]="page>=lastPage">›</button>
            <button class="btn-page btn-ghost" (click)="loadPage(lastPage)" [disabled]="page>=lastPage">»</button>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="!items || items.length===0">Nenhuma sessão encontrada</div>
  </div>

  <!-- Dialog-based modal and explicit overlay to ensure full-viewport coverage -->
  <div *ngIf="modalOpen" class="dialog-overlay" (click)="closeDialog()"></div>
  <dialog #reconDialog class="recon-dialog" (click)="onDialogClick($event)" (cancel)="closeDialog($event)">
    <h3>Relatório de Reconciliação - Sessão {{ modalData?.id || '' }}</h3>
    <div *ngIf="!modalData">Carregando...</div>
    <div *ngIf="modalData?.error">{{ modalData.error }}</div>
    <div *ngIf="modalData && !modalData.error">
      <p><strong>Saldo Inicial:</strong> R$&nbsp;{{ modalData.saldo_inicial | number:'1.2-2' }}</p>
      <p><strong>Saldo Esperado:</strong> R$&nbsp;{{ modalData.saldo_esperado | number:'1.2-2' }}</p>
      <p><strong>Saldo Contado:</strong> R$&nbsp;{{ modalData.saldo_contado | number:'1.2-2' }}</p>
      <p><strong>Variação:</strong> R$&nbsp;{{ modalData.variacao | number:'1.2-2' }}</p>
      <h4>Totais por método</h4>
      <div class="totals-list">
        <div *ngFor="let k of getKeys(modalData.totals_by_metodo)" class="total-item">
          <span class="method-label">{{ getMethodLabel(k) }}:</span>
          <span class="method-value">R$ {{ modalData.totals_by_metodo[k] | number:'1.2-2' }}</span>
        </div>
      </div>
      <h4>Movimentações</h4>
      <table class="small-table">
        <tr><th>ID</th><th>Tipo</th><th>Valor</th><th>Usuário</th><th>Descrição</th><th>Data</th></tr>
        <tr *ngFor="let m of modalData.movimentacoes">
          <td>{{ m.id }}</td>
          <td>{{ m.tipo }}</td>
          <td>R$ {{ m.valor | number:'1.2-2' }}</td>
          <td>{{ m.usuario || '-' }}</td>
          <td>{{ m.descricao || '-' }}</td>
          <td>{{ m.data_movimento | date:'dd/MM/yyyy HH:mm' }}</td>
        </tr>
      </table>
      <h4>Vendas</h4>
      <table class="small-table">
        <tr><th>ID</th><th>Data</th><th>Total</th><th>Operador</th></tr>
        <tr *ngFor="let v of modalData.vendas">
          <td><a href="#" (click)="openVendaDetalhada($event, v.id)">{{ v.id }}</a></td>
          <td>{{ v.data_venda | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>R$ {{ v.total_final | number:'1.2-2' }}</td>
          <td>{{ v.operador || '-' }}</td>
        </tr>
      </table>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeDialog()">Fechar</button>
        <button class="btn-secondary" (click)="exportCsv()">Exportar CSV</button>
      </div>
    </div>
  </dialog>
  <!-- tooltip is rendered dynamically and appended to document.body -->
</div>


