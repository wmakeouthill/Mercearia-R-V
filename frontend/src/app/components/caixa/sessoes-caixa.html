<div class="caixa-container">
  <div class="top-bar">
    <div class="form-mov">
      <h3>Registro de Sess√µes</h3>
      <div class="acoes-form"></div>
    </div>
    <div class="acoes-topo">
      <button class="btn-voltar btn-voltar-compact no-wrap" (click)="voltar()">‚Üê&nbsp;Voltar ao Dashboard</button>
    </div>
  </div>

  <div class="lista">
    <div class="lista-header">
      <h3>Sess√µes</h3>
      <div class="lista-controls">
        <label>
          Linhas:
          <select [(ngModel)]="size" (change)="onSizeChange()" class="compact">
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
            <option [ngValue]="100">100</option>
          </select>
        </label>
      </div>
    </div>
    <div class="filtros bloco-filtros">
      <div class="filtros-inputs">
        <label>
          In√≠cio
          <input type="date" [(ngModel)]="filtroPeriodoInicio" />
        </label>
        <label>
          Fim
          <input type="date" [(ngModel)]="filtroPeriodoFim" />
        </label>
        <label>
          M√™s
          <input type="month" [(ngModel)]="filtroMes" />
        </label>
        <label>
          Usu√°rio Abertura
          <input type="text" [ngModel]="filtroUsuarioAbertura" (ngModelChange)="onFiltroUsuarioAberturaChange($event)" placeholder="nome" />
        </label>
        <label>
          Usu√°rio Fechamento
          <input type="text" [ngModel]="filtroUsuarioFechamento" (ngModelChange)="onFiltroUsuarioFechamentoChange($event)" placeholder="nome" />
        </label>
        <label>
          Status
          <select [(ngModel)]="filtroStatus">
            <option value="">Todos</option>
            <option value="aberto">Abertas</option>
            <option value="fechado">Fechadas</option>
          </select>
        </label>
      </div>
      <div class="acoes-filtros">
        <button class="action-btn btn-filtrar" (click)="aplicarFiltros()">üîç Filtrar</button>
        <button class="action-btn btn-limpar" (click)="limparFiltros()">üîÑ Limpar</button>
      </div>
    </div>
    <div *ngIf="loading">Carregando...</div>
    <div *ngIf="error" class="erro">{{ error }}</div>
    <div *ngIf="items && items.length">
      <div class="tabela-wrapper">
        <table class="sessoes-table">
          <colgroup>
            <!-- fixed-percent layout to prevent header overlap; sums to 100% -->
            <col style="width:4%" />   <!-- ID -->
            <col style="width:4%" />   <!-- Aberto -->
            <col style="width:12%" />  <!-- Abertura -->
            <col style="width:12%" />  <!-- Usu√°rio (Abertura) -->
            <col style="width:8%" />   <!-- Fechamento -->
            <col style="width:12%" />  <!-- Usu√°rio (Fechamento) -->
            <col style="width:8%" />   <!-- Saldo Inicial -->
            <col style="width:8%" />   <!-- Saldo Contado -->
            <col style="width:8%" />   <!-- Varia√ß√£o -->
            <col style="width:8%" />   <!-- Cumul. Antes -->
            <col style="width:8%" />   <!-- Cumul. Global -->
            <col style="min-width:160px" />   <!-- A√ß√£o (min width) -->
          </colgroup>
          <thead>
            <tr>
              <th class="center">ID</th>
              <th class="center">Aberto</th>
              <th><span>Abertura</span></th>
              <th class="break-two"><span>Usu√°rio</span><span>(Abertura)</span></th>
              <th><span>Fechamento</span></th>
              <th class="break-two"><span>Usu√°rio</span><span>(Fechamento)</span></th>
              <th class="right"><span>Saldo</span><span>Inicial</span></th>
              <th class="right"><span>Saldo</span><span>Contado</span></th>
              <th class="right break-two"><span>Varia√ß√£o</span><span>(sess√£o)</span></th>
              <th class="right break-two"><span>Cumul.</span><span>Antes</span></th>
              <th class="right break-two"><span>Cumul.</span><span>Global</span></th>
              <th class="center acao">A√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of items">
              <td class="center">{{ it.id }}</td>
              <td class="center">{{ it.aberto ? 'Sim' : 'N√£o' }}</td>
              <td>{{ it.data_abertura | date:'dd/MM/yyyy HH:mm' }}</td>
              <td class="break-two">{{ it.aberto_por || '-' }}</td>
              <td>{{ it.data_fechamento ? (it.data_fechamento | date:'dd/MM/yyyy HH:mm') : '-' }}</td>
              <td class="break-two">{{ it.fechado_por || '-' }}</td>
              <td class="right">R$&nbsp;{{ it.saldo_inicial | number:'1.2-2' }}</td>
              <td class="right">R$&nbsp;{{ it.saldo_contado | number:'1.2-2' }}</td>
              <td class="right">R$&nbsp;{{ it.variacao | number:'1.2-2' }}</td>
              <td class="right">R$&nbsp;{{ it.cumulative_variacao_before | number:'1.2-2' }}</td>
              <td class="right">R$&nbsp;{{ it.cumulative_variacao_all | number:'1.2-2' }}</td>
              <td class="center acao">
                <div style="display:flex; gap:8px; align-items:center; justify-content:center">
                  <button class="btn-primary btn-registro" (click)="openReconciliation(it.id)">Relat√≥rio</button>
                  <button class="btn-secondary btn-registro btn-excluir-compact" type="button" (click)="$event.stopPropagation(); onSessBtnClickLog(it.id); onDeleteSessionClick(it.id)" [disabled]="!authService.isAdmin() || !it?.id" [attr.title]="!authService.isAdmin() ? 'Somente administradores' : 'Excluir sess√£o'">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="paginacao">
          <div class="pagination-left">
            <button class="btn-page btn-ghost" (click)="goToFirstPage()" [disabled]="page<=1" title="Primeira">¬´</button>
            <button class="btn-page btn-ghost" (click)="goBy(-10)" [disabled]="page<=1" title="-10">¬´10</button>
            <button class="btn-page btn-ghost" (click)="goBy(-5)" [disabled]="page<=1" title="-5">¬´5</button>
            <button class="btn-page btn-ghost" (click)="prevPage()" [disabled]="page<=1" title="Anterior">‚Äπ</button>
          </div>
          <div class="pagination-center">
            <ng-container *ngFor="let p of paginationItems">
              <span *ngIf="p==='‚Ä¶'" class="ellipsis">‚Ä¶</span>
              <button *ngIf="p!=='‚Ä¶'" class="btn-page" [class.active]="p === page" (click)="goToPage(toNumber(p))">{{ p }}</button>
            </ng-container>
          </div>
          <div class="pagination-right">
            <button class="btn-page btn-ghost" (click)="nextPage()" [disabled]="page>=totalPages" title="Pr√≥xima">‚Ä∫</button>
            <button class="btn-page btn-ghost" (click)="goBy(5)" [disabled]="page>=totalPages" title="+5">5¬ª</button>
            <button class="btn-page btn-ghost" (click)="goBy(10)" [disabled]="page>=totalPages" title="+10">10¬ª</button>
            <button class="btn-page btn-ghost" (click)="goToLastPage()" [disabled]="page>=totalPages" title="√öltima">¬ª</button>
          </div>
          <div class="pagination-jump">
            <label>
              Ir para
              <input type="number" min="1" [max]="totalPages" [(ngModel)]="jumpPage" (keyup.enter)="goToPage(jumpPage)" />
            </label>
            <button class="btn-go" (click)="goToPage(jumpPage)">Ir</button>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="!items || items.length===0">Nenhuma sess√£o encontrada</div>
  </div>

  <!-- Dialog-based modal and explicit overlay to ensure full-viewport coverage -->
  <div *ngIf="modalOpen" class="dialog-overlay" (click)="closeDialog()"></div>
  <dialog #reconDialog class="recon-dialog" (click)="onDialogClick($event)" (cancel)="closeDialog($event)">
    <h3>Relat√≥rio de Reconcilia√ß√£o - Sess√£o {{ modalData?.id || '' }}</h3>
    <div *ngIf="!modalData">Carregando...</div>
    <div *ngIf="modalData?.error">{{ modalData.error }}</div>
    <div *ngIf="modalData && !modalData.error">
      <p><strong>Saldo Inicial:</strong> R$&nbsp;{{ modalData.saldo_inicial | number:'1.2-2' }}</p>
      <p><strong>Saldo Esperado:</strong> R$&nbsp;{{ modalData.saldo_esperado | number:'1.2-2' }}</p>
      <p><strong>Saldo Contado:</strong> R$&nbsp;{{ modalData.saldo_contado | number:'1.2-2' }}</p>
      <p><strong>Varia√ß√£o (sess√£o):</strong> R$&nbsp;{{ modalData.variacao | number:'1.2-2' }}</p>
      <p *ngIf="modalData.cumulative_variacao_before !== undefined"><strong>Cumulativo antes (todas sess√µes anteriores):</strong> R$&nbsp;{{ modalData.cumulative_variacao_before | number:'1.2-2' }}</p>
      <p *ngIf="modalData.cumulative_variacao_all !== undefined"><strong>Cumulativo geral (todas sess√µes):</strong> R$&nbsp;{{ modalData.cumulative_variacao_all | number:'1.2-2' }}</p>
      <p *ngIf="modalData.deficit_nao_reposto_before !== undefined"><strong>D√©ficit n√£o reposto (antes):</strong> R$&nbsp;{{ modalData.deficit_nao_reposto_before | number:'1.2-2' }}</p>
      <p *ngIf="modalData.day_variacao_total !== undefined"><strong>Varia√ß√£o total do dia:</strong> R$&nbsp;{{ modalData.day_variacao_total | number:'1.2-2' }}</p>
      <p *ngIf="modalData.day_saldo_inicial_total !== undefined"><strong>Saldo inicial total do dia:</strong> R$&nbsp;{{ modalData.day_saldo_inicial_total | number:'1.2-2' }}</p>
      <h4>Totais por m√©todo</h4>
      <div class="totals-list">
        <div *ngFor="let k of getKeys(modalData.totals_by_metodo)" class="total-item">
          <span class="method-label">{{ getMethodLabel(k) }}:</span>
          <span class="method-value">R$ {{ modalData.totals_by_metodo[k] | number:'1.2-2' }}</span>
        </div>
      </div>
      <h4>Movimenta√ß√µes</h4>
      <table class="small-table">
        <tr><th>ID</th><th>Tipo</th><th>Valor</th><th>Usu√°rio</th><th>Descri√ß√£o</th><th>Data</th></tr>
        <tr *ngFor="let m of modalData.movimentacoes">
          <td>{{ m.id }}</td>
          <td>{{ m.tipo }}</td>
          <td>R$ {{ m.valor | number:'1.2-2' }}</td>
          <td>{{ m.usuario || '-' }}</td>
          <td>{{ m.descricao || '-' }}</td>
          <td>{{ m.data_movimento | date:'dd/MM/yyyy HH:mm' }}</td>
        </tr>
      </table>
      <h4>Vendas</h4>
      <table class="small-table">
        <tr><th>ID</th><th>Data</th><th>Total</th><th>Operador</th></tr>
        <tr *ngFor="let v of modalData.vendas">
          <td><a href="#" (click)="openVendaDetalhada($event, v.id)">{{ v.id }}</a></td>
          <td>{{ v.data_venda | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>R$ {{ v.total_final | number:'1.2-2' }}</td>
          <td>{{ v.operador || '-' }}</td>
        </tr>
      </table>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeDialog()">Fechar</button>
        <button class="btn-secondary" (click)="exportCsv()">Exportar CSV</button>
      </div>
    </div>
  </dialog>
  <!-- tooltip is rendered dynamically and appended to document.body -->
</div>


