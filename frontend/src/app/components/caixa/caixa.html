<div class="caixa-container">
  <div class="top-bar">
    <div class="filtros">
      <label>
        Modo
        <select [(ngModel)]="filtroModo" (change)="onChangeModo()">
          <option value="tudo">Tudo</option>
          <option value="dia">Dia</option>
          <option value="mes">M√™s</option>
        </select>
      </label>
      <label>
        Data
        <input type="date" [(ngModel)]="dataSelecionada" (change)="onChangeData()" [disabled]="filtroModo!=='dia'" />
      </label>
      <label>
        M√™s
        <input type="month" [(ngModel)]="mesSelecionado" (change)="onChangeMes()" [disabled]="filtroModo!=='mes'" />
      </label>
    </div>
    <div class="form-mov">
      <h3>Nova Movimenta√ß√£o</h3>
      <label>
        Tipo
        <select [(ngModel)]="tipo">
          <option value="entrada">Entrada</option>
          <option value="retirada">Retirada</option>
        </select>
      </label>
      <label>
        Valor
        <input type="number" [(ngModel)]="valor" min="0" step="0.01" />
      </label>
      <label class="flex-1">
        Descri√ß√£o
        <input type="text" [(ngModel)]="descricao" placeholder="Opcional" />
      </label>
      <button (click)="registrar()" [disabled]="loading">Registrar</button>
    </div>
  </div>

  <div class="top-bar filtros-secundarios">
    <div class="filtros">
      <label>
        Exibir
        <select [(ngModel)]="pageSize" (change)="setPageSize(pageSize)">
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
          <option [ngValue]="100">100</option>
        </select>
      </label>
      <div style="flex:1"></div>
      <button class="action-btn" (click)="exportarCsv()">Exportar CSV</button>
      <button class="action-btn config-btn" (click)="voltarAoDashboard()">Voltar ao Dashboard</button>
    </div>
  </div>

  <div class="top-bar filtros-secundarios">
    <div class="filtros">
      <label>
        Tipo
        <select [(ngModel)]="filtroTipo" (change)="aplicarFiltrosMovs()">
          <option value="">Todos</option>
          <option value="entrada">Entrada</option>
          <option value="retirada">Retirada</option>
          <option value="venda">Venda</option>
        </select>
      </label>
      <label>
        M√©todo
        <select [(ngModel)]="filtroMetodo" (change)="aplicarFiltrosMovs()">
          <option value="">Todos</option>
          <option value="dinheiro">Dinheiro</option>
          <option value="cartao_credito">Cart√£o Cr√©dito</option>
          <option value="cartao_debito">Cart√£o D√©bito</option>
          <option value="pix">PIX</option>
        </select>
      </label>
      <label>
        In√≠cio
        <input type="time" [(ngModel)]="filtroHoraInicio" (change)="aplicarFiltrosMovs()" />
      </label>
      <label>
        Fim
        <input type="time" [(ngModel)]="filtroHoraFim" (change)="aplicarFiltrosMovs()" />
      </label>
      <button class="action-btn config-btn" (click)="aplicarFiltrosMovs()">Filtrar</button>
      <button class="action-btn close-btn" (click)="limparFiltrosMovs()">Limpar</button>
    </div>
  </div>

   @if (resumoVendasDia) {<div class="resumo">
    <div class="card">
      <div class="titulo">Receita de Vendas (dia)</div>
      <div class="valor positivo">
        R$ {{ totalVendasHoje | number:'1.2-2' }}
      </div>
    </div>
    <div class="card">
      <div class="titulo">Saldo de Movimenta√ß√µes (dia)</div>
      <div class="valor" [class.positivo]="saldoMovimentacoesHoje >= 0" [class.negativo]="saldoMovimentacoesHoje < 0">
        R$ {{ saldoMovimentacoesHoje | number:'1.2-2' }}
      </div>
    </div>
    <div class="card">
      <div class="titulo">Total no Caixa (vendas + movs)</div>
      <div class="valor" [class.positivo]="totalNoCaixaHoje >= 0" [class.negativo]="totalNoCaixaHoje < 0">
        R$ {{ totalNoCaixaHoje | number:'1.2-2' }}
      </div>
    </div>
     <div class="card">
       <div class="titulo">Somat√≥rios do Per√≠odo</div>
       <div class="valor positivo">Entradas: R$ {{ sumEntradas | number:'1.2-2' }}</div>
       <div class="valor negativo">Retiradas: R$ {{ sumRetiradas | number:'1.2-2' }}</div>
       <div class="valor">Vendas: R$ {{ sumVendas | number:'1.2-2' }}</div>
     </div>
  </div>}

  <div class="mensagens">
    @if (error) {<div class="erro" (click)="error = ''" (keydown.enter)="error = ''" (keydown.space)="error = ''">{{ error }}</div>}
    @if (success) {<div class="sucesso" (click)="success = ''" (keydown.enter)="success = ''" (keydown.space)="success = ''">{{ success }}</div>}
  </div>

  <div class="lista">
    <h3>Movimenta√ß√µes do dia</h3>
     @if (!movimentacoes || movimentacoes.length === 0) {<div class="vazia">Sem movimenta√ß√µes</div>}
     @if (movimentacoes && movimentacoes.length > 0) {
      <div class="tabela-wrapper">
        <div class="tabela-cabecalho">
          <button class="th tipo sort" (click)="setSort('tipo')">Tipo</button>
          <div class="th produto">Produto</div>
          <button class="th valor sort" (click)="setSort('valor')">Valor</button>
          <div class="th descricao">Descri√ß√£o</div>
          <button class="th metodo sort" (click)="setSort('metodo')">M√©todo</button>
          <div class="th usuario">Usu√°rio</div>
          <button class="th data sort" (click)="setSort('data')">Data/Hora</button>
        </div>
        @for (m of movimentacoes; track $index) {
          <div class="item">
            <div class="col tipo">
              <span class="badge" [ngClass]="{entrada: m.tipo === 'entrada', retirada: m.tipo === 'retirada', venda: m.tipo === 'venda'}">
                @if (m.tipo === 'entrada') {<span class="icon">‚ûï</span>}
                @if (m.tipo === 'retirada') {<span class="icon">‚ûñ</span>}
                @if (m.tipo === 'venda') {<span class="icon">üõí</span>}
                <span class="label">{{ m.tipo }}</span>
              </span>
            </div>
            <div class="col produto">{{ m.produto_nome || '-' }}</div>
            <div class="col valor">R$ {{ m.valor | number:'1.2-2' }}</div>
            <div class="col descricao">{{ m.descricao || '-' }}</div>
            <div class="col metodo">
              @if (m.metodo_pagamento) {
                <span class="metodo-badge">{{ getMetodoLabel(m.metodo_pagamento) }} ¬∑ R$ {{ (m.pagamento_valor || 0) | number:'1.2-2' }}</span>
              } @else {
                <span>-</span>
              }
            </div>
            <div class="col usuario">{{ m.usuario || '-' }}</div>
            <div class="col data">{{ m.data_movimento | date:'short' }}</div>
          </div>
        }
         <div class="paginacao" style="display:flex; gap:12px; padding:12px 16px; align-items:center; justify-content:flex-end;">
           <button class="action-btn close-btn" (click)="prevPage()" [disabled]="page<=1">Anterior</button>
           <div style="min-width:60px; text-align:center; font-weight:700; color: var(--primary-blue);">{{ page }}</div>
           <button class="action-btn config-btn" (click)="nextPage()">Pr√≥xima</button>
         </div>
      </div>
    }
  </div>
</div>


