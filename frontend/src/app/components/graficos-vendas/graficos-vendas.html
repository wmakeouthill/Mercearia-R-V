<div class="graficos-page">
  <div class="header">
    <h1>Gráficos de Vendas</h1>
    <div class="acoes-header">
      <button class="btn-voltar" (click)="voltarRelatorio()">← Voltar</button>
    </div>
  </div>

  <div class="filtros">
    <div class="grupo-col">
      <span class="filtro-label">Granularidade</span>
      <div class="grupo-botoes">
        <button [class.ativo]="granularidade==='dia'" (click)="alterarGranularidade('dia')">Diário</button>
        <button [class.ativo]="granularidade==='mes'" (click)="alterarGranularidade('mes')">Mensal</button>
        <button [class.ativo]="granularidade==='trimestre'" (click)="alterarGranularidade('trimestre')">Trimestral</button>
        <button [class.ativo]="granularidade==='semestre'" (click)="alterarGranularidade('semestre')">Semestral</button>
        <button [class.ativo]="granularidade==='ano'" (click)="alterarGranularidade('ano')">Anual</button>
      </div>
    </div>
    <div class="grupo-col" *ngIf="granularidade!=='dia'">
      <span class="filtro-label">Ano</span>
      <select [(ngModel)]="anoSelecionado" (change)="aplicarFiltros()" class="select-ano">
        <option *ngFor="let a of anosDisponiveis" [ngValue]="a">{{ a }}</option>
      </select>
    </div>
    <div class="grupo-col">
      <span class="filtro-label">Período (datas)</span>
      <div class="datas-range">
        <input type="date" [(ngModel)]="dataInicio" (change)="aplicarFiltros()"/>
        <span class="ate">até</span>
        <input type="date" [(ngModel)]="dataFim" (change)="aplicarFiltros()"/>
      </div>
    </div>
    <div class="grupo-col acoes-filtro">
      <button class="btn-aplicar" (click)="aplicarFiltros()">Aplicar</button>
      <button class="btn-limpar" (click)="dataInicio=''; dataFim=''; aplicarFiltros()">Limpar</button>
    </div>
  </div>

  <div *ngIf="carregando" class="loading">Carregando dados...</div>
  <div *ngIf="erro" class="erro">{{ erro }}</div>

  <div class="grid-graficos" *ngIf="!carregando && !erro">
    <div class="grafico-card wide">
      <div class="card-header">
        <h3>Série Temporal ({{ granularidade | titlecase }})
          <button *ngIf="selectedDiaSerie && granularidade==='dia'" type="button" class="badge-filtro" (click)="selectedDiaSerie=null; recalcularTudo()" title="Filtro de dia ativo. Clique para limpar.">
            Dia: {{ formatDia(selectedDiaSerie) }} ✕
          </button>
        </h3>
        <div class="acoes">
          <button class="btn-export csv" (click)="exportarCSV('serie')">CSV</button>
          <button class="btn-export png" (click)="exportarPNG('chartSerie')">PNG</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="chartSerie" baseChart [data]="serieTemporalData" [options]="chartOptionsLine" [type]="'line'" (chartClick)="onSerieClick($event)" ></canvas>
      </div>
    </div>
    <div class="grafico-card">
      <div class="card-header">
        <h3>Receita por Hora</h3>
        <div class="acoes">
          <button class="btn-export csv" (click)="exportarCSV('hora')">CSV</button>
          <button class="btn-export png" (click)="exportarPNG('chartHora')">PNG</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="sub-header-filtros" *ngIf="selectedHora!=null">
          <button type="button" class="badge-filtro" (click)="limparFiltroHora()">Hora: {{ (selectedHora||0) | number:'2.0' }}h ✕</button>
        </div>
        <canvas id="chartHora" baseChart [data]="vendasPorHoraData" [options]="chartOptionsBar" [type]="'bar'" (chartClick)="onHoraClick($event)"></canvas>
      </div>
    </div>
    <div class="grafico-card">
      <div class="card-header">
        <h3>Receita por Dia da Semana</h3>
        <div class="acoes">
          <button class="btn-export csv" (click)="exportarCSV('dia-semana')">CSV</button>
          <button class="btn-export png" (click)="exportarPNG('chartDiaSemana')">PNG</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="sub-header-filtros" *ngIf="selectedDiaSemana!=null">
          <button type="button" class="badge-filtro" (click)="limparFiltroDiaSemana()">Dia: {{ vendasPorDiaSemanaData?.labels?.[selectedDiaSemana!] }} ✕</button>
        </div>
        <canvas id="chartDiaSemana" baseChart [data]="vendasPorDiaSemanaData" [options]="chartOptionsBar" [type]="'bar'" (chartClick)="onDiaSemanaClick($event)"></canvas>
      </div>
    </div>
    <div class="grafico-card">
      <div class="card-header">
        <h3>Receita por Método</h3>
        <div class="acoes">
          <button class="btn-export csv" (click)="exportarCSV('metodo')">CSV</button>
          <button class="btn-export png" (click)="exportarPNG('chartMetodo')">PNG</button>
        </div>
      </div>
      <div class="filtros-ativos" *ngIf="resumoFiltros.length">
        <span class="label">Filtros:</span>
        <ng-container *ngFor="let f of resumoFiltros; let i = index">
          <span class="chip">{{ f }}</span>
          <span class="sep" *ngIf="i < resumoFiltros.length - 1">+</span>
        </ng-container>
        <button type="button" class="limpar" (click)="limparTodosFiltros()" title="Limpar todos filtros">Limpar ✕</button>
      </div>
      <div class="chart-wrapper">
        <canvas id="chartMetodo" baseChart [data]="receitaPorMetodoData" [options]="chartOptionsPie" [type]="'pie'"></canvas>
      </div>
    </div>
    <div class="grafico-card">
      <div class="card-header">
        <h3>Top 10 Itens</h3>
        <div class="acoes">
          <button class="btn-export csv" (click)="exportarCSV('itens')">CSV</button>
          <button class="btn-export png" (click)="exportarPNG('chartItens')">PNG</button>
        </div>
      </div>
      <div class="filtros-ativos" *ngIf="resumoFiltros.length">
        <span class="label">Filtros:</span>
        <ng-container *ngFor="let f of resumoFiltros; let i = index">
          <span class="chip">{{ f }}</span>
          <span class="sep" *ngIf="i < resumoFiltros.length - 1">+</span>
        </ng-container>
        <button type="button" class="limpar" (click)="limparTodosFiltros()" title="Limpar todos filtros">Limpar ✕</button>
      </div>
      <div class="chart-wrapper">
        <canvas id="chartItens" baseChart [data]="itensMaisVendidosData" [options]="chartOptionsBar" [type]="'bar'"></canvas>
      </div>
    </div>
  </div>
</div>
