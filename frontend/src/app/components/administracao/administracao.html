<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <div class="header-content">
      <div class="title-section">
        <div class="title-info">
          <h1>Administra√ß√£o</h1>
          <p>Gerenciar usu√°rios e configura√ß√µes do sistema</p>
        </div>
      </div>
      <div class="user-info header-actions">
        <span class="current-user">{{ currentUser?.username }}</span>
        <span class="user-badge">Administrador</span>
        <button (click)="goToClientes()" class="action-button secondary-button">üë• Clientes</button>
        <button (click)="goBack()" class="btn-voltar">‚Üê Voltar ao Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="admin-content">
    <!-- Loading -->
    @if (loading) {<div class="loading">
      <div class="loading-spinner"></div>
      <span>Carregando...</span>
    </div>}

    <!-- Messages -->
    @if (error) {<div class="message error-message" (click)="clearMessages()" (keydown.enter)="clearMessages()" (keydown.space)="clearMessages()">
      <span class="message-icon">‚ö†Ô∏è</span>
      <span>{{ error }}</span>
      <button class="close-btn">√ó</button>
    </div>}

    @if (success) {<div class="message success-message" (click)="clearMessages()" (keydown.enter)="clearMessages()" (keydown.space)="clearMessages()">
      <span class="message-icon">‚úÖ</span>
      <span>{{ success }}</span>
      <button class="close-btn">√ó</button>
    </div>}

    <!-- Action Buttons -->
    <div class="action-bar">
      <button (click)="toggleChangePasswordForm()" class="action-button primary-button"
        [class.active]="showChangePasswordForm">
        <span class="button-icon">üîê</span>
        Alterar Minha Senha
      </button>

      <button (click)="toggleNewUserForm()" class="action-button secondary-button" [class.active]="showNewUserForm">
        <span class="button-icon">üë§+</span>
        Criar Usu√°rio
      </button>
    </div>

    <!-- Change Password Form -->
    @if (showChangePasswordForm) {<div class="form-section">
      <div class="form-card">
        <div class="form-header">
          <h3>Alterar Senha</h3>
          <button (click)="toggleChangePasswordForm()" class="close-form-btn">√ó</button>
        </div>
        <form (ngSubmit)="changePassword()" class="admin-form">
          <div class="form-row">
            <div class="form-group">
              <label for="currentPassword">Senha Atual</label>
              <input type="password" id="currentPassword" [(ngModel)]="passwordChange.currentPassword"
                name="currentPassword" placeholder="Digite sua senha atual" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="newPassword">Nova Senha</label>
              <input type="password" id="newPassword" [(ngModel)]="passwordChange.newPassword" name="newPassword"
                placeholder="Digite a nova senha" required>
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirmar Nova Senha</label>
              <input type="password" id="confirmPassword" [(ngModel)]="passwordChange.confirmPassword"
                name="confirmPassword" placeholder="Confirme a nova senha" required>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" (click)="resetPasswordForm()" class="cancel-button">
              Cancelar
            </button>
            <button type="submit" class="submit-button" [disabled]="loading">
              @if (loading) {<span class="loading-spinner small"></span>}
              {{ loading ? 'Alterando...' : 'Alterar Senha' }}
            </button>
          </div>
        </form>
      </div>
    </div>}

    <!-- New User Form -->
    @if (showNewUserForm) {<div class="form-section">
      <div class="form-card">
        <div class="form-header">
          <h3>Criar Novo Usu√°rio</h3>
          <button (click)="toggleNewUserForm()" class="close-form-btn">√ó</button>
        </div>
        <form (ngSubmit)="createUser()" class="admin-form">
          <div class="form-row">
            <div class="form-group">
              <label for="newUsername">Nome de Usu√°rio</label>
              <input type="text" id="newUsername" [(ngModel)]="newUser.username" name="newUsername"
                placeholder="Digite o nome de usu√°rio" required>
            </div>

            <div class="form-group">
              <label for="newUserRole">Perfil</label>
              <select id="newUserRole" [(ngModel)]="newUser.role" name="newUserRole" required>
                <option value="user">Operador</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="newUserPassword">Senha</label>
              <input type="password" id="newUserPassword" [(ngModel)]="newUser.password" name="newUserPassword"
                placeholder="Digite a senha" required>
            </div>

            @if (newUser.role === 'user') {<div class="form-group toggle-field">
              <label for="newUserCaixaToggle">Pode controlar caixa</label>
              <button id="newUserCaixaToggle" type="button" class="switch" [class.on]="newUser.pode_controlar_caixa" (click)="newUser.pode_controlar_caixa = !newUser.pode_controlar_caixa" [attr.aria-pressed]="newUser.pode_controlar_caixa">
                <span class="switch-knob"></span>
              </button>
              <span class="switch-text">{{ newUser.pode_controlar_caixa ? 'ON' : 'OFF' }}</span>
              <p class="help-text">Permite ao operador abrir/fechar o caixa</p>
            </div>}
          </div>

          <div class="form-actions">
            <button type="button" (click)="resetNewUserForm()" class="cancel-button">
              Cancelar
            </button>
            <button type="submit" class="submit-button" [disabled]="loading">
              @if (loading) {<span class="loading-spinner small"></span>}
              {{ loading ? 'Criando...' : 'Criar Usu√°rio' }}
            </button>
          </div>
        </form>
      </div>
    </div>}

    <!-- Users List -->
    <div class="users-section">
      <div class="section-header">
        <h2>Usu√°rios do Sistema</h2>
        <span class="users-count">{{ users.length }} usu√°rios</span>
      </div>

      @if (users.length === 0 && !loading) {<div class="empty-state">
        <div class="empty-icon">üë•</div>
        <h3>Nenhum usu√°rio encontrado</h3>
        <p>Ainda n√£o h√° usu√°rios cadastrados no sistema.</p>
      </div>}

      @if (users.length > 0) {<div class="users-list">
        @for (user of users; track user.id) {<div class="user-card" [class.editing]="user.isEditing">
          <!-- View Mode -->
          @if (!user.isEditing) {<div class="user-view">
            <div class="user-info">
              <div class="user-avatar">
                {{ user.username.charAt(0).toUpperCase() }}
              </div>
              <div class="user-details">
                <h4>{{ user.username }}</h4>
                <span class="user-role" [class.admin-role]="user.role === 'admin'">
                  {{ getRoleDisplayName(user.role) }}
                </span>
                @if (user.id === currentUser?.id) {<span class="current-user-badge">Voc√™</span>}
                <div class="user-permissions">
                  @if (user.role === 'admin') {<span class="permission-badge admin-permission">
                    üîê Acesso Total
                  </span>}
                  @if (user.role === 'user') {
                    @if (user.pode_controlar_caixa) {<span class="permission-badge caixa-permission" title="Pode abrir/fechar caixa">
                      üóùÔ∏è Controla Caixa
                    </span>} @else {<span class="permission-badge limited-permission" title="Sem permiss√£o de caixa">
                      üë§ Acesso Limitado
                    </span>}
                  }
                </div>
              </div>
            </div>

            <div class="user-actions">
              <button (click)="editUser(user)" class="edit-button" title="Editar usu√°rio">
                ‚úèÔ∏è
              </button>
              <button (click)="deleteUser(user)" class="delete-button" [disabled]="user.id === currentUser?.id"
                title="Deletar usu√°rio">
                üóëÔ∏è
              </button>
            </div>
          </div>}

          <!-- Edit Mode -->
          @if (user.isEditing) {<div class="user-edit">
            <div class="edit-form">
              <div class="edit-row">
                <div class="edit-group">
                  <label for="editUsername">Nome de Usu√°rio</label>
                  <input id="editUsername" type="text" [(ngModel)]="user.username" placeholder="Nome de usu√°rio">
                </div>

              <div class="edit-group">
                  <label for="editRole">Perfil</label>
                  <select id="editRole" [(ngModel)]="user.role">
                    <option value="user">Operador</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
              </div>

              <div class="edit-row">
                <div class="edit-group">
                  <label for="newPassOpt">Nova Senha (opcional)</label>
                  <input id="newPassOpt" type="password" [(ngModel)]="user.password" placeholder="Deixe em branco para manter a atual">
                </div>

                @if (user.role === 'user') {<div class="edit-group toggle-field">
                  <label for="editUserCaixaToggle-{{user.id}}">Pode controlar caixa</label>
                  <button id="editUserCaixaToggle-{{user.id}}" type="button" class="switch" [class.on]="user.pode_controlar_caixa" (click)="user.pode_controlar_caixa = !user.pode_controlar_caixa" [attr.aria-pressed]="user.pode_controlar_caixa">
                    <span class="switch-knob"></span>
                  </button>
                  <span class="switch-text">{{ user.pode_controlar_caixa ? 'ON' : 'OFF' }}</span>
                  <p class="help-text">Permite ao operador abrir/fechar o caixa</p>
                </div>}
              </div>


              <div class="edit-actions">
                <button (click)="cancelEdit(user)" class="cancel-button">
                  Cancelar
                </button>
                <button (click)="updateUser(user)" class="save-button" [disabled]="loading">
                  @if (loading) {<span class="loading-spinner small"></span>}
                  {{ loading ? 'Salvando...' : 'Salvar' }}
                </button>
              </div>
            </div>
          </div>}
        </div>}
      </div>}
    </div>
  </div>
</div>
