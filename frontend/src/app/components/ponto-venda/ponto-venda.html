<div class="ponto-venda-container">
    <div class="ponto-venda-header">
        <h1>Ponto de Venda</h1>
        <div class="header-actions">
            <button (click)="voltarAoDashboard()" class="btn-voltar">‚Üê Voltar ao Dashboard</button>
        </div>
    </div>

    @if (error) {<div class="error-message">
        {{ error }}
    </div>}

    @if (sucesso) {<div class="success-message">
        {{ sucesso }}
    </div>}

    <!-- Notifica√ß√£o Moderna -->
    @if (showModernNotification) {<div class="modern-notification" [class.show]="showModernNotification">
        <div class="notification-content">
            <div class="notification-icon">‚úÖ</div>
            <div class="notification-text">{{ modernNotificationMessage }}</div>
            <button class="notification-close" (click)="hideModernNotification()">√ó</button>
        </div>
    </div>}

    <div class="ponto-venda-content">
        <!-- Se√ß√£o de Sele√ß√£o de Produtos -->
        <div class="selecao-produtos">
            <h2>Selecionar Produtos</h2>

            <!-- Busca por Nome ou C√≥digo -->
            <div class="busca-produtos">
                <div class="busca-input-container">
                    <input type="text" [(ngModel)]="termoPesquisa" (input)="onSearchChange()"
                        placeholder="Digite o nome ou c√≥digo do produto..." class="input-pesquisa">
                    <div class="busca-icon">üîç</div>
                </div>
                @if (termoPesquisa.trim()) {<div class="busca-info">
                    {{ produtosFiltrados.length }} produto(s) encontrado(s)
                </div>}
            </div>

            <!-- Lista de Produtos -->
            <div class="lista-produtos">
                <h3>Produtos Dispon√≠veis</h3>
                <div class="produtos-grid">
                    @for (produto of produtosFiltrados; track produto.id) {<button type="button" class="produto-card"
                        [class.selecionado]="produtoSelecionado?.id === produto.id"
                        (click)="selecionarProduto(produto)"
                        (keydown.enter)="selecionarProduto(produto)">
                        <div class="produto-imagem-card">
                            <img [src]="getImageUrl(produto.imagem)"
                                 [alt]="produto.nome"
                                 class="produto-card-imagem"
                                 (error)="onImageError($event)">
                            <div class="produto-sem-imagem">üñºÔ∏è</div>
                        </div>
                        <div class="produto-info">
                            <h4>{{ produto.nome }}</h4>
                            <p><strong>C√≥digo:</strong> {{ produto.codigo_barras || 'N/A' }}</p>
                        </div>
                        <div class="produto-preco-estoque">
                            <span class="preco">R$ {{ produto.preco_venda.toFixed(2) }}</span>
                            <span class="estoque">Est: {{ produto.quantidade_estoque }}</span>
                            @if (produtoSelecionado?.id === produto.id) {<div class="qtd-arrows" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
                                <span class="qtd-num">{{ quantidade }}</span>
                                <button type="button" class="qtd-btn" (click)="increaseQuantidadeSelecionada(produto.quantidade_estoque)" title="Aumentar">+</button>
                            </div>}
                        </div>
                        <div class="produto-acao-col">
                            @if (produtoSelecionado?.id === produto.id) {<div class="quantidade-inline">
                                <input type="number"
                                       [(ngModel)]="quantidade"
                                       min="1"
                                       [max]="produto.quantidade_estoque"
                                       class="input-qtd-inline"
                                       (click)="$event.stopPropagation()"
                                       (mousedown)="$event.stopPropagation()">
                                <button (click)="adicionarAoCarrinho(false); $event.stopPropagation()"
                                        class="btn-add-inline"
                                        title="Adicionar ao carrinho">
                                    <span class="icon">üõí</span>
                                </button>
                            </div>}
                        </div>

                    </button>}
                </div>
            </div>

            <!-- Dica de Sele√ß√£o -->
            @if (!produtoSelecionado && produtosFiltrados.length > 0) {<div class="dica-selecao">
                <div class="dica-icon">üëÜ</div>
                <p>Clique em um produto para selecion√°-lo e adicionar ao carrinho</p>
                <small>üí° Pressione <strong>Enter</strong> para adicionar o produto selecionado ao carrinho</small>
            </div>}

            <!-- Nenhum produto encontrado -->
            @if (termoPesquisa.trim() && produtosFiltrados.length === 0) {<div class="nenhum-produto">
                <div class="nenhum-icon">‚ùå</div>
                <p>Nenhum produto encontrado para "{{ termoPesquisa }}"</p>
                <small>Tente buscar por outro nome ou c√≥digo</small>
            </div>}
        </div>

        <!-- Se√ß√£o do Carrinho -->
        <div class="carrinho-section">
            <h2>Carrinho de Compras</h2>



            <!-- Resumo Fixo do Carrinho -->
            @if (carrinho.length > 0) {<div class="carrinho-resumo-fixo">
                <div class="resumo-info">
                    <span class="resumo-itens">{{ carrinho.length }} item(s)</span>
                    <span class="resumo-total">R$ {{ getTotalCarrinho().toFixed(2) }}</span>
                </div>
                <div class="resumo-acoes">
                    <button (click)="limparCarrinho()" class="btn-limpar-pequeno" title="Limpar carrinho">üóëÔ∏è</button>
                </div>
            </div>}

            @if (carrinho.length === 0) {<div class="carrinho-vazio">
                <div class="vazio-icon">üõí</div>
                <p>Nenhum produto no carrinho</p>
                <small>Selecione produtos √† esquerda para adicionar</small>
            </div>}

            @if (carrinho.length > 0) {<div class="carrinho-items">
                @for (item of carrinho; track i; let i = $index) {<div class="carrinho-item">
                    <div class="item-imagem">
                        <img [src]="getImageUrl(item.produto.imagem)"
                             [alt]="item.produto.nome"
                             class="carrinho-produto-imagem"
                             (error)="onImageError($event)">
                    </div>
                    <div class="item-info">
                        <h4>{{ item.produto.nome }}</h4>
                        <p>R$ {{ item.preco_unitario.toFixed(2) }} cada</p>
                    </div>
                    <div class="item-controles">
                        <div class="item-quantidade">
                            <button (click)="atualizarQuantidade(item, item.quantidade - 1)" class="btn-quantidade"
                                title="Diminuir quantidade">-</button>
                            <span class="quantidade">{{ item.quantidade }}</span>
                            <button (click)="atualizarQuantidade(item, item.quantidade + 1)" class="btn-quantidade"
                                title="Aumentar quantidade">+</button>
                        </div>
                        <div class="item-total">
                            R$ {{ item.preco_total.toFixed(2) }}
                        </div>
                        <button (click)="removerDoCarrinho(i)" class="btn-remover" title="Remover item">üóëÔ∏è</button>
                    </div>
                </div>}

                <div class="carrinho-total-detalhado">
                    <div class="total-linha total-final">
                        <span><strong>Total:</strong></span>
                        <span><strong>R$ {{ getTotalCarrinho().toFixed(2) }}</strong></span>
                    </div>
                    @if (pagamentos.length >= 2 && getFaltaTotal() > 0) {<div class="total-falta">
                        <span>Falta:</span>
                        <span>R$ {{ getFaltaTotal().toFixed(2) }}</span>
                    </div>}
                </div>

                <!-- Pagamentos -->
                <div class="pagamentos-section">
                    <div class="pagamentos-header">
                        <span class="metodo-label">Pagamentos:</span>
                        <div class="metodos-opcoes">
                            @for (metodo of metodosDisponiveis; track metodo.valor) {<button class="btn-metodo-compacto"
                                    (click)="adicionarPagamento(metodo.valor)" [title]="'Adicionar '+metodo.nome">
                                <span class="metodo-icone">{{ metodo.icone }}</span>
                                <span class="metodo-nome-curto">{{ getMetodoLabelCurto(metodo.valor) }}</span>
                            </button>}
                        </div>
                    </div>
                    @if (pagamentos.length > 0) {<div class="pagamentos-lista">
                        @for (p of pagamentos; track i; let i = $index) {<div class="pagamento-item">
                            <div class="pagamento-metodo">{{ getMetodoPagamentoNome(p.metodo) }}</div>
                            <input type="number" class="pagamento-valor" [(ngModel)]="p.valor" min="0" step="0.01">
                            <button class="btn-remover" (click)="removerPagamento(i)" title="Remover">üóëÔ∏è</button>
                        </div>}
                        <div class="pagamento-total" [class.invalido]="!isPagamentoValido()">
                            <span>Total Pagamentos:</span>
                            <span>R$ {{ getTotalPagamentos().toFixed(2) }} / R$ {{ getTotalCarrinho().toFixed(2) }}</span>
                        </div>
                    </div>}
                </div>

                <div class="carrinho-acoes-principais">
                    <button (click)="limparCarrinho()" class="btn-limpar">
                        üóëÔ∏è Limpar Carrinho
                    </button>
                    <button (click)="finalizarVenda()"
                            [disabled]="loading || !podeFinalizar"
                            class="btn-finalizar"
                            [class.bloqueado]="!podeFinalizar"
                            [title]="!podeFinalizar ? 'Defina o m√©todo/valor do pagamento antes de finalizar' : ''">
                        @if (loading) {<span>‚è≥ Finalizando...</span>} @else {<span>üí≥ Finalizar Venda</span>}
                    </button>
                </div>
            </div>}
        </div>
    </div>
</div>

@if (showEnviarModal) {<app-enviar-nota-modal [orderId]="modalOrderId" (close)="closeEnviarModal()"></app-enviar-nota-modal>}
@if (showConfirmModal) {<app-confirm-modal [title]="'Venda finalizada'" [message]="confirmMessage" (confirm)="onConfirmSend()" (cancel)="onCancelSend()"></app-confirm-modal>}
