<div class="ponto-venda-container">
    <div class="ponto-venda-header">
        <h1>Ponto de Venda</h1>
        <button (click)="voltarAoDashboard()" class="btn-voltar">‚Üê Voltar ao Dashboard</button>
    </div>

    <div class="error-message" *ngIf="error">
        {{ error }}
    </div>

    <div class="success-message" *ngIf="sucesso">
        {{ sucesso }}
    </div>

    <!-- Notifica√ß√£o Moderna -->
    <div class="modern-notification" *ngIf="showModernNotification" [class.show]="showModernNotification">
        <div class="notification-content">
            <div class="notification-icon">‚úÖ</div>
            <div class="notification-text">{{ modernNotificationMessage }}</div>
            <button class="notification-close" (click)="hideModernNotification()">√ó</button>
        </div>
    </div>

    <div class="ponto-venda-content">
        <!-- Se√ß√£o de Sele√ß√£o de Produtos -->
        <div class="selecao-produtos">
            <h2>Selecionar Produtos</h2>

            <!-- Busca por Nome ou C√≥digo -->
            <div class="busca-produtos">
                <div class="busca-input-container">
                    <input type="text" [(ngModel)]="termoPesquisa" (input)="onSearchChange()"
                        placeholder="Digite o nome ou c√≥digo do produto..." class="input-pesquisa">
                    <div class="busca-icon">üîç</div>
                </div>
                <div class="busca-info" *ngIf="termoPesquisa.trim()">
                    {{ produtosFiltrados.length }} produto(s) encontrado(s)
                </div>
            </div>

            <!-- Lista de Produtos -->
            <div class="lista-produtos">
                <h3>Produtos Dispon√≠veis</h3>
                <div class="produtos-grid">
                    <div *ngFor="let produto of produtosFiltrados" class="produto-card"
                        [class.selecionado]="produtoSelecionado?.id === produto.id"
                        (click)="selecionarProduto(produto)">
                        <div class="produto-imagem-card">
                            <img [src]="getImageUrl(produto.imagem)"
                                 [alt]="produto.nome"
                                 class="produto-card-imagem"
                                 (error)="onImageError($event)">
                        </div>
                        <div class="produto-info">
                            <h4>{{ produto.nome }}</h4>
                            <p><strong>C√≥digo:</strong> {{ produto.codigo_barras || 'N/A' }}</p>
                            <div class="produto-preco-estoque">
                                <span class="preco">R$ {{ produto.preco_venda.toFixed(2) }}</span>
                                <span class="estoque">Est: {{ produto.quantidade_estoque }}</span>
                            </div>
                        </div>
                        <div class="produto-actions" *ngIf="produtoSelecionado?.id === produto.id">
                            <div class="quantidade-inline">
                                <input type="number" [(ngModel)]="quantidade" min="1" [max]="produto.quantidade_estoque"
                                    class="input-qtd-inline">
                                <button (click)="adicionarAoCarrinho(false); $event.stopPropagation()"
                                    class="btn-add-inline">+ Carrinho</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dica de Sele√ß√£o -->
            <div class="dica-selecao" *ngIf="!produtoSelecionado && produtosFiltrados.length > 0">
                <div class="dica-icon">üëÜ</div>
                <p>Clique em um produto para selecion√°-lo e adicionar ao carrinho</p>
                <small>üí° Pressione <strong>Enter</strong> para adicionar o produto selecionado ao carrinho</small>
            </div>

            <!-- Nenhum produto encontrado -->
            <div class="nenhum-produto" *ngIf="termoPesquisa.trim() && produtosFiltrados.length === 0">
                <div class="nenhum-icon">‚ùå</div>
                <p>Nenhum produto encontrado para "{{ termoPesquisa }}"</p>
                <small>Tente buscar por outro nome ou c√≥digo</small>
            </div>
        </div>

        <!-- Se√ß√£o do Carrinho -->
        <div class="carrinho-section">
            <h2>Carrinho de Compras</h2>



            <!-- Resumo Fixo do Carrinho -->
            <div class="carrinho-resumo-fixo" *ngIf="carrinho.length > 0">
                <div class="resumo-info">
                    <span class="resumo-itens">{{ carrinho.length }} item(s)</span>
                    <span class="resumo-total">R$ {{ getTotalCarrinho().toFixed(2) }}</span>
                </div>
                <div class="resumo-acoes">
                    <button (click)="limparCarrinho()" class="btn-limpar-pequeno" title="Limpar carrinho">üóëÔ∏è</button>
                </div>
            </div>

            <div class="carrinho-vazio" *ngIf="carrinho.length === 0">
                <div class="vazio-icon">üõí</div>
                <p>Nenhum produto no carrinho</p>
                <small>Selecione produtos √† esquerda para adicionar</small>
            </div>

            <div class="carrinho-items" *ngIf="carrinho.length > 0">
                <div class="carrinho-item" *ngFor="let item of carrinho; let i = index">
                    <div class="item-imagem">
                        <img [src]="getImageUrl(item.produto.imagem)"
                             [alt]="item.produto.nome"
                             class="carrinho-produto-imagem"
                             (error)="onImageError($event)">
                    </div>
                    <div class="item-info">
                        <h4>{{ item.produto.nome }}</h4>
                        <p>R$ {{ item.preco_unitario.toFixed(2) }} cada</p>
                    </div>
                    <div class="item-controles">
                        <div class="item-quantidade">
                            <button (click)="atualizarQuantidade(item, item.quantidade - 1)" class="btn-quantidade"
                                title="Diminuir quantidade">-</button>
                            <span class="quantidade">{{ item.quantidade }}</span>
                            <button (click)="atualizarQuantidade(item, item.quantidade + 1)" class="btn-quantidade"
                                title="Aumentar quantidade">+</button>
                        </div>
                        <div class="item-total">
                            R$ {{ item.preco_total.toFixed(2) }}
                        </div>
                        <button (click)="removerDoCarrinho(i)" class="btn-remover" title="Remover item">üóëÔ∏è</button>
                    </div>
                </div>

                <div class="carrinho-total-detalhado">
                    <div class="total-linha total-final">
                        <span><strong>Total:</strong></span>
                        <span><strong>R$ {{ getTotalCarrinho().toFixed(2) }}</strong></span>
                    </div>
                </div>

                <!-- Pagamentos -->
                <div class="pagamentos-section">
                    <div class="pagamentos-header">
                        <span class="metodo-label">Pagamentos:</span>
                        <div class="metodos-opcoes">
                            <button *ngFor="let metodo of metodosDisponiveis" class="btn-metodo-compacto"
                                    (click)="adicionarPagamento(metodo.valor)" [title]="'Adicionar '+metodo.nome">
                                <span class="metodo-icone">{{ metodo.icone }}</span>
                                <span class="metodo-nome-curto">{{ metodo.nome.split(' ')[0] }}</span>
                            </button>
                        </div>
                    </div>
                    <div class="pagamentos-lista" *ngIf="pagamentos.length > 0">
                        <div class="pagamento-item" *ngFor="let p of pagamentos; let i = index">
                            <div class="pagamento-metodo">{{ getMetodoPagamentoNome(p.metodo) }}</div>
                            <input type="number" class="pagamento-valor" [(ngModel)]="p.valor" min="0" step="0.01">
                            <button class="btn-remover" (click)="removerPagamento(i)" title="Remover">üóëÔ∏è</button>
                        </div>
                        <div class="pagamento-total" [class.invalido]="!isPagamentoValido()">
                            <span>Total Pagamentos:</span>
                            <span>R$ {{ getTotalPagamentos().toFixed(2) }} / R$ {{ getTotalCarrinho().toFixed(2) }}</span>
                        </div>
                    </div>
                </div>

                <div class="carrinho-acoes-principais">
                    <button (click)="limparCarrinho()" class="btn-limpar">
                        üóëÔ∏è Limpar Carrinho
                    </button>
                    <button (click)="finalizarVenda()" [disabled]="loading" class="btn-finalizar">
                        <span *ngIf="loading">‚è≥ Finalizando...</span>
                        <span *ngIf="!loading">üí≥ Finalizar Venda</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
