<div class="modal-overlay" (click)="cancel()" (keydown)="null">
  <div class="modal" (click)="$event.stopPropagation()" (keydown)="null">
    <h3>Venda #{{ saleSummary.id }} - Detalhes</h3>
    <div *ngIf="loading">Carregando...</div>
    <div *ngIf="!loading && saleDetails">
      <table>
        <thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Preço</th><th>Ação</th><th>Qtd</th><th>Substituto</th><th>Valores</th></tr></thead>
        <tbody>
          <tr *ngFor="let it of saleDetails.itens">
            <td class="product-cell">{{ it.produto_nome }}</td>
            <td>{{ it.quantidade }}</td>
            <td class="price-cell">{{ it.preco_total | currencyBR }}</td>
            <td class="action-cell">
              <div class="action-stack">
                <label class="action-option"><input type="radio" name="action-{{it.produto_id}}" [(ngModel)]="selections[it.produto_id]" [ngModelOptions]="{standalone: true}" [value]="'return'"> <span>Devolver</span></label>
                <label class="action-option"><input type="radio" name="action-{{it.produto_id}}" [(ngModel)]="selections[it.produto_id]" [ngModelOptions]="{standalone: true}" [value]="'exchange'"> <span>Trocar</span></label>
              </div>
            </td>
            <td><input type="number" [(ngModel)]="quantities[it.produto_id]" min="1" [max]="it.quantidade"></td>
            <td>
              <div class="searchable-select">
                <input type="text" [(ngModel)]="replacementSearch[it.produto_id]" (input)="onReplacementSearch(it.produto_id)" (focus)="onReplacementFocus(it.produto_id, $event)" (blur)="hideReplacementListDelayed(it.produto_id)" [disabled]="selections[it.produto_id] !== 'exchange'" [ngModelOptions]="{standalone: true}" placeholder="Buscar produto...">
                <ul *ngIf="showReplacementList[it.produto_id] && (replacementVisible[it.produto_id] || []).length > 0" class="options-list" [ngStyle]="replacementPosition[it.produto_id]">
                  <li *ngFor="let p of replacementVisible[it.produto_id]" (mousedown)="selectReplacement(it.produto_id, p)">{{p.nome}} ({{p.quantidade_estoque}})</li>
                </ul>
                <div *ngIf="showReplacementList[it.produto_id]" class="options-footer">
                  <button (mousedown)="replacementPrev(it.produto_id)" [disabled]="(replacementPage[it.produto_id]||0) <= 0">‹</button>
                  <span>{{(replacementPage[it.produto_id]||0)+1}} / {{replacementTotalPages[it.produto_id]||1}}</span>
                  <button (mousedown)="replacementNext(it.produto_id)" [disabled]="(replacementPage[it.produto_id]||0) >= ((replacementTotalPages[it.produto_id]||1)-1)">›</button>
                </div>
              </div>
            </td>
            <td class="value-cell">
              <div class="value-controls" [class.disabled]="selections[it.produto_id] !== 'exchange'">
                <div class="value-type">
                  <label><input type="radio" name="valtype-{{it.produto_id}}" [(ngModel)]="valueAdjustments[it.produto_id].type" [ngModelOptions]="{standalone: true}" [value]="'refund'"> <span>Troco</span></label>
                  <label><input type="radio" name="valtype-{{it.produto_id}}" [(ngModel)]="valueAdjustments[it.produto_id].type" [ngModelOptions]="{standalone: true}" [value]="'charge'"> <span>Adicionar</span></label>
                </div>
                <input type="number" step="0.01" [(ngModel)]="valueAdjustments[it.produto_id].amount" [ngModelOptions]="{standalone: true}" [disabled]="selections[it.produto_id] !== 'exchange'" class="value-input" placeholder="0,00">
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="actions"><button (click)="confirmActions()">Confirmar</button><button (click)="cancel()">Cancelar</button></div>
    </div>
  </div>
</div>


