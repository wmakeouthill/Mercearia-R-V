<div class="modal-overlay" (click)="cancel()" (keydown)="null">
  <div class="modal" (click)="$event.stopPropagation()" (keydown)="null">
    <h3>Venda #{{ saleSummary.id }} - Detalhes</h3>
    <div *ngIf="loading">Carregando...</div>
    <div *ngIf="!loading && saleDetails">
      <div class="adjustments" *ngIf="saleDetails.adjustments && saleDetails.adjustments.length>0">
        <h4>Histórico de Ajustes</h4>
        <table class="adjustments-table">
          <thead><tr><th>Tipo</th><th>Item</th><th>Qtd</th><th>Prod.Rep</th><th>Diff</th><th>Operador</th><th>Data</th><th>Notas</th></tr></thead>
          <tbody>
            <tr *ngFor="let a of saleDetails.adjustments">
              <td>{{a.type}}</td>
              <td>{{a.sale_item_id || '-'}}</td>
              <td>{{a.quantity}}</td>
              <td>{{a.replacement_product_id || '-'}}</td>
              <td>{{a.price_difference | currencyBR}}</td>
              <td>{{a.operator_username || '-'}}</td>
              <td>{{a.created_at | date:'short'}}</td>
              <td>{{a.notes || ''}}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <table>
        <thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Preço</th><th>Ação</th><th>Qtd</th><th>Substituto</th><th>Valores</th></tr></thead>
        <tbody>
          <tr *ngFor="let it of saleDetails.itens">
            <td class="product-cell" [title]="getUnitPriceTooltip(it)">{{ it.produto_nome }}</td>
            <td>{{ it.quantidade }}</td>
            <td class="price-cell">{{ it.preco_total | currencyBR }}</td>
            <td class="action-cell">
              <div class="action-stack">
                <label class="action-option" (click)="$event.stopPropagation(); toggleSelection(it.produto_id, 'return', $event)"><input type="radio" name="action-{{it.produto_id}}" [checked]="selections[it.produto_id] === 'return'"> <span>Devolver</span></label>
                <label class="action-option" (click)="$event.stopPropagation(); toggleSelection(it.produto_id, 'exchange', $event)"><input type="radio" name="action-{{it.produto_id}}" [checked]="selections[it.produto_id] === 'exchange'"> <span>Trocar</span></label>
              </div>
            </td>
            <td><input type="number" [(ngModel)]="quantities[it.produto_id]" min="1" [max]="it.quantidade"></td>
            <td>
              <div class="searchable-select">
                <input type="text" [(ngModel)]="replacementSearch[it.produto_id]" (input)="onReplacementSearch(it.produto_id)" (focus)="onReplacementFocus(it.produto_id, $event)" (blur)="hideReplacementListDelayed(it.produto_id)" [disabled]="selections[it.produto_id] !== 'exchange'" [ngModelOptions]="{standalone: true}" placeholder="Buscar produto...">
                <ul *ngIf="showReplacementList[it.produto_id] && (replacementVisible[it.produto_id] || []).length > 0" class="options-list" [ngStyle]="{ top: replacementPosition[it.produto_id].top, left: replacementPosition[it.produto_id].left, width: replacementPosition[it.produto_id].width }" (mousedown)="onDropdownMouseDown(it.produto_id, $event)">
                  <li class="options-footer" (mousedown)="onDropdownMouseDown(it.produto_id, $event)">
                    <button (mousedown)="replacementPrev(it.produto_id)" [disabled]="(replacementPage[it.produto_id]||0) <= 0">‹</button>
                    <span>{{(replacementPage[it.produto_id]||0)+1}} / {{replacementTotalPages[it.produto_id]||1}}</span>
                    <button (mousedown)="replacementNext(it.produto_id)" [disabled]="(replacementPage[it.produto_id]||0) >= ((replacementTotalPages[it.produto_id]||1)-1)">›</button>
                  </li>
                  <li *ngFor="let p of replacementVisible[it.produto_id]" (mousedown)="selectReplacement(it.produto_id, p)">
                    <div class="opt-name">{{p.nome}}</div>
                    <div class="opt-meta">R$ {{p.preco_venda | currencyBR}} • Qtd: {{p.quantidade_estoque}}</div>
                  </li>
                </ul>
              </div>
            </td>
            <td class="value-cell">
              <div class="value-controls" [class.disabled]="selections[it.produto_id] !== 'exchange'">
                <div class="value-type">
                  <label><input type="radio" name="valtype-{{it.produto_id}}" [(ngModel)]="valueAdjustments[it.produto_id].type" [ngModelOptions]="{standalone: true}" [value]="'refund'"> <span>Troco</span></label>
                  <label><input type="radio" name="valtype-{{it.produto_id}}" [(ngModel)]="valueAdjustments[it.produto_id].type" [ngModelOptions]="{standalone: true}" [value]="'charge'"> <span>Adicionar</span></label>
                </div>
                <input type="number" step="0.01" [(ngModel)]="valueAdjustments[it.produto_id].amount" [ngModelOptions]="{standalone: true}" [disabled]="selections[it.produto_id] !== 'exchange'" class="value-input" placeholder="0,00">
                <div class="payments-area" *ngIf="selections[it.produto_id] === 'exchange'">
                  <div *ngFor="let p of paymentsByItem[it.produto_id]; let i = index" class="payment-row">
                    <select [(ngModel)]="paymentsByItem[it.produto_id][i].metodo" [ngModelOptions]="{standalone: true}">
                      <option value="dinheiro">Dinheiro</option>
                      <option value="cartao">Cartão</option>
                      <option value="pix">PIX</option>
                      <option value="outro">Outro</option>
                    </select>
                    <input type="number" step="0.01" [(ngModel)]="paymentsByItem[it.produto_id][i].valor" [ngModelOptions]="{standalone: true}" placeholder="0,00">
                    <button type="button" (click)="paymentsByItem[it.produto_id].splice(i,1)">Remover</button>
                  </div>
                  <div class="payments-controls">
                    <button type="button" (click)="paymentsByItem[it.produto_id].push({ metodo: 'dinheiro', valor: 0 })">Adicionar pagamento</button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="actions"><button (click)="confirmActions()">Confirmar</button><button (click)="cancel()">Cancelar</button></div>
    </div>
  </div>
</div>


